name: GH Pages Deploy (Otimizado)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout 🛎
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check for relevant changes
        id: verify-changed-files
        run: |
          if [ -n "$(git diff --name-only HEAD~1 | grep -E '\.(md|yaml|yml|css|js)$|^marmite\.yaml$|^content/|^site/')" ]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "📝 Mudanças detectadas, executando build..."
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "⏭️ Nenhuma mudança relevante, pulando build..."
          fi

      - name: Cache Cargo
        if: steps.verify-changed-files.outputs.changes == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Cache target directory
        if: steps.verify-changed-files.outputs.changes == 'true'
        uses: actions/cache@v4
        with:
          path: |
            target
          key: ${{ runner.os }}-target-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-

      - name: Install marmite 🫙
        if: steps.verify-changed-files.outputs.changes == 'true'
        run: |
          if ! command -v marmite &> /dev/null; then
            echo "Instalando marmite..."
            cargo install marmite
          else
            echo "Marmite já instalado, pulando..."
          fi

      - name: Prepare build environment 🧹
        if: steps.verify-changed-files.outputs.changes == 'true'
        run: |
          rm -rf site
          mkdir -p site

      - name: Build site 🏗️
        if: steps.verify-changed-files.outputs.changes == 'true'
        run: |
          echo "🏗️ Construindo site..."
          marmite . site --debug --colorscheme gruvbox
          echo "✅ Build concluído!"

      - name: Verify build
        if: steps.verify-changed-files.outputs.changes == 'true'
        run: |
          if [ ! -f "site/index.html" ]; then
            echo "❌ Erro: index.html não encontrado!"
            exit 1
          fi
          echo "✅ Site gerado com sucesso!"

      - name: Setup Pages
        if: steps.verify-changed-files.outputs.changes == 'true'
        uses: actions/configure-pages@v5

      - name: Upload artifact
        if: steps.verify-changed-files.outputs.changes == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'site'

      - name: Deploy to GitHub Pages
        if: steps.verify-changed-files.outputs.changes == 'true'
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Build skipped
        if: steps.verify-changed-files.outputs.changes == 'false'
        run: echo "⏭️ Build pulado - nenhuma mudança relevante detectada"
